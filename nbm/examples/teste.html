<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ABCJS Example</title>
    <script src="../dist/abcjs-basic.js" type="text/javascript"></script>
</head>
<body onload="load()">
    <textarea id="abc-input" rows="10" cols="50">
T:Cindy
M:4/4
K:G
%%score (harmony melody)
L:1/4
[V: harmony]
g||"G"gggg|dB2g|gggd|g3g|
"G"gggd|dcB2|dccA|Bzz2|
"C"G2cc|ccd/c/B|"G"G4-|Gzz2|
"C"G2cc|cc2c|"D7"dddc|"G"B2z2|]
"C"E2GG|AG2A|"D7"BBBA|"G"G2z2|]
    </textarea>
    <div id="paper"></div>
    <fieldset>
        <legend>Options</legend>
        <h2>Transpose Parameters</h2>
        <label>Visual:
            <input class="visual-transpose" type="number" min="-24" max="24" step="1" value="0">
        </label>
        <label>Audio:
            <input class="audio-transpose" type="number" min="-24" max="24" step="1" value="0">
        </label>
        <h2>ABC Insertions</h2>
        <button class="midi-command">Add %%MIDI command</button>
        <button class="key-command">Add transpose to K:</button>
        <button class="voice-command">Add transpose to V:</button>
    </fieldset>
    <button class="play-chords">Play Chords</button>
    <button class="play-melodies">Play Melodies</button>
    <button class="play-harmony">Play Harmony</button>
    <button class="play-melody">Play Melody</button>
    <button class="play-all">Play All</button>
    <button class="stop-audio" style="display:none;">Stop</button>
    <div class="audio-error" style="display:none;">Audio not supported</div>

    <script type="text/javascript">
        function load() {
            var abcTextarea = document.getElementById("abc-input");
            var visualObj;

            function renderABC() {
                var abc = abcTextarea.value;
                var visualTranspose = parseInt(document.querySelector(".visual-transpose").value, 10);
                visualObj = ABCJS.renderAbc("paper", abc, { responsive: "resize", visualTranspose: visualTranspose })[0];
            }

            abcTextarea.addEventListener("input", renderABC);
            document.querySelector(".visual-transpose").addEventListener("input", renderABC);
            renderABC();

            var midiBuffer;

            var startChordsButton = document.querySelector(".play-chords");
            var startMelodiesButton = document.querySelector(".play-melodies");
            var startHarmonyButton = document.querySelector(".play-harmony");
            var startMelodyButton = document.querySelector(".play-melody");
            var startAllButton = document.querySelector(".play-all");
            var stopAudioButton = document.querySelector(".stop-audio");

            startChordsButton.addEventListener("click", function() {
                var options = { voicesOff: true };
                play(options);
            });

            startMelodiesButton.addEventListener("click", function() {
                var options = { chordsOff: true };
                play(options);
            });

            startHarmonyButton.addEventListener("click", function() {
                var options = { chordsOff: true, voicesOff: [1] };
                play(options);
            });

            startMelodyButton.addEventListener("click", function() {
                var options = { chordsOff: true, voicesOff: [0] };
                play(options);
            });

            startAllButton.addEventListener("click", function() {
                var options = {};
                play(options);
            });

            function play(options) {
                startChordsButton.style.display = "none";
                startMelodiesButton.style.display = "none";
                startHarmonyButton.style.display = "none";
                startMelodyButton.style.display = "none";
                startAllButton.style.display = "none";
                if (ABCJS.synth.supportsAudio()) {
                    stopAudioButton.style.display = "";

                    window.AudioContext = window.AudioContext ||
                        window.webkitAudioContext ||
                        navigator.mozAudioContext ||
                        navigator.msAudioContext;
                    var audioContext = new window.AudioContext();
                    audioContext.resume().then(function () {
                        midiBuffer = new ABCJS.synth.CreateSynth();
                        var audioTranspose = parseInt(document.querySelector(".audio-transpose").value, 10);
                        return midiBuffer.init({
                            visualObj: visualObj,
                            audioContext: audioContext,
                            millisecondsPerMeasure: visualObj.millisecondsPerMeasure(),
                            options: options,
                            midiTranspose: audioTranspose
                        }).then(function (response) {
                            return midiBuffer.prime();
                        }).then(function () {
                            return midiBuffer.start();
                        }).catch(function (error) {
                            if (error.status === "NotSupported") {
                                stopAudioButton.style.display = "none";
                                var audioError = document.querySelector(".audio-error");
                                audioError.style.display = "";
                            } else {
                                console.warn("synth error", error);
                            }
                        });
                    });
                } else {
                    var audioError = document.querySelector(".audio-error");
                    audioError.style.display = "";
                }
            }

            stopAudioButton.addEventListener("click", function() {
                startChordsButton.style.display = "";
                startMelodiesButton.style.display = "";
                startHarmonyButton.style.display = "";
                startMelodyButton.style.display = "";
                startAllButton.style.display = "";
                stopAudioButton.style.display = "none";
                if (midiBuffer) {
                    midiBuffer.stop();
                }
            });

            document.querySelector(".midi-command").addEventListener("click", onMidiCommand);
            document.querySelector(".key-command").addEventListener("click", onKeyCommand);
            document.querySelector(".voice-command").addEventListener("click", onVoiceCommand);

            function onMidiCommand() {
                var abc = abcTextarea.value;
                abc = abc.split("\n");
                abc[0] += "\n%%MIDI transpose 2";
                abc = abc.join("\n");
                abcTextarea.value = abc;
                renderABC();
            }

            function onKeyCommand() {
                var abc = abcTextarea.value;
                abc = abc.split("K:");
                if (abc.length > 1) {
                    var arr = abc[1].split("\n");
                    arr[0] = " Em transpose=-2";
                    abc[1] = arr.join("\n");
                }
                abc = abc.join("K:");
                abcTextarea.value = abc;
                renderABC();
            }

            function onVoiceCommand() {
                var abc = abcTextarea.value;
                abc = abc.split("V:");
                if (abc.length > 1) {
                    var arr = abc[1].split("\n");
                    arr[0] = " Melody transpose=-2";
                    abc[1] = arr.join("\n");
                }
                abc = abc.join("V:");
                abcTextarea.value = abc;
                renderABC();
            }
        }
    </script>
</body>
</html>
