<html><head><base href="https://music.education/interactive-notation/" />
<title>NBM - Escola</title>
<style>
    body {
        font-family: 'Comic Sans MS', cursive, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #FFD700;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><text x="50" y="50" font-size="80" text-anchor="middle" dy=".35em" fill="rgba(255,255,255,0.1)">‚ô´</text></svg>');
    }
    #chalkboard {
        width: 90%;
        height: 300px;
        background-color: #28a745;
        border: 20px solid #8B4513;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-y: auto;
        box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    #input {
        width: 90%;
        height: 100px;
        font-size: 24px;
        margin-bottom: 20px;
        padding: 10px;
        border: 5px solid #FF69B4;
        border-radius: 15px;
        background-color: #FFF5EE;
    }
    .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    button {
        font-size: 24px;
        padding: 15px 30px;
        cursor: pointer;
        background-color: #FF69B4;
        border: none;
        border-radius: 50px;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 5px #FF1493;
    }
    button:hover {
        background-color: #FF1493;
        transform: translateY(-3px);
        box-shadow: 0 8px #C71585;
    }
    button:active {
        transform: translateY(2px);
        box-shadow: 0 3px #C71585;
    }
    .slider {
        width: 250px;
        -webkit-appearance: none;
        height: 25px;
        background: #FFA07A;
        outline: none;
        border-radius: 15px;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 35px;
        height: 35px;
        background: #FF4500;
        cursor: pointer;
        border-radius: 50%;
    }
    .slider::-moz-range-thumb {
        width: 35px;
        height: 35px;
        background: #FF4500;
        cursor: pointer;
        border-radius: 50%;
    }
    #midiFileInput {
        margin-bottom: 20px;
        font-size: 18px;
    }
    #noteNames {
        font-size: 24px;
        margin-bottom: 20px;
        background-color: #FFF5EE;
        padding: 10px;
        border-radius: 10px;
        border: 3px solid #FF69B4;
    }
    .midi-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
    }
    h1 {
        font-size: 48px;
        color: #FF1493;
        text-shadow: 3px 3px #FFB6C1;
        margin-bottom: 30px;
    }
    h3{
        color: #06525f; 
    }
</style>
</head>
<body>
<h1>üéµ NBM - Escola de M√∫sica üéµ</h1>
<div id="chalkboard"></div>
<textarea id="input" placeholder="digite"></textarea>
<div class="controls">
    <button id="playBtn">‚ñ∂Ô∏è Tocar</button>
    <button id="pauseBtn">‚è∏Ô∏è Pausa</button>
    <button id="stopBtn">‚èπÔ∏è Parar</button>
    <button id="loopBtn">üîÅ Loop: Off</button>
    <button id="toggleNoteNamesBtn">üéº Mostrar Notas</button>
</div>
<div class="controls">
    <label for="tempo">üèÉ‚Äç‚ôÇÔ∏è Tempo: <span id="tempoValue">120</span> BPM</label>
    <input type="range" id="tempo" class="slider" min="60" max="240" value="120">
</div>
<div class="controls">
    <label for="volume">üîä Volume: <span id="volumeValue">100</span>%</label>
    <input type="range" id="volume" class="slider" min="0" max="100" value="100">
</div>
<div class="controls">
    <label for="fontSize">üìè Font Size: <span id="fontSizeValue">72</span>px</label>
    <input type="range" id="fontSize" class="slider" min="24" max="120" value="72">
</div>
<div class="controls">
    <input type="file" id="midiFileInput" accept=".mid,.midi">
    <button id="toggleMidiBtn">üéπ MIDI: Off</button>
</div>
<div class="midi-controls">
    <button id="playMidiBtn">‚ñ∂Ô∏è Tocar MIDI</button>
    <div class="controls">
        <label for="midiVolume">üéπ MIDI Volume: <span id="midiVolumeValue">100</span>%</label>
        <input type="range" id="midiVolume" class="slider" min="0" max="100" value="100">
    </div>
</div>
<div id="noteNames"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<script src="https://unpkg.com/@tonejs/midi"></script>
<script>
    const chalkboard = document.getElementById('chalkboard');
    const input = document.getElementById('input');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const loopBtn = document.getElementById('loopBtn');
    const tempoSlider = document.getElementById('tempo');
    const tempoValue = document.getElementById('tempoValue');
    const volumeSlider = document.getElementById('volume');
    const volumeValue = document.getElementById('volumeValue');
    const fontSizeSlider = document.getElementById('fontSize');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const midiFileInput = document.getElementById('midiFileInput');
    const toggleMidiBtn = document.getElementById('toggleMidiBtn');
    const toggleNoteNamesBtn = document.getElementById('toggleNoteNamesBtn');
    const noteNamesDiv = document.getElementById('noteNames');
    const playMidiBtn = document.getElementById('playMidiBtn');
    const midiVolumeSlider = document.getElementById('midiVolume');
    const midiVolumeValue = document.getElementById('midiVolumeValue');

    let isPlaying = false;
    let isLooping = false;
    let isMidiActive = false;
    let currentIndex = 0;
    let sequence = [];

    const noteMap = {
        '1': 'Do', '2': 'Re', '3': 'Mi', '4': 'Fa', '5': 'Sol', '6': 'La', '7': 'Si',
        'x': 'Rest', '-': 'Rest'
    };

    const colorMap = {
        '1': '#FF0000', '2': '#FFA500', '3': '#FFFF00', '4': '#00FF00',
        '5': '#0000FF', '6': '#4B0082', '7': '#EE82EE', 'x': '#000000', '-': '#000000'
    };

    const synth = new Tone.Synth({
        oscillator: {
            type: 'triangle'
        },
        envelope: {
            attack: 0.05,
            decay: 0.1,
            sustain: 0.3,
            release: 0.5
        }
    }).toDestination();
    let midiPart = null;

    function parseInput(text) {
        const regex = /(\d['',]*(?:\/+)?\.?|-|x)/g;
        return text.match(regex) || [];
    }

    function updateChalkboard() {
        const numbers = parseInput(input.value);
        chalkboard.innerHTML = numbers.map(num => {
            const baseNum = num.charAt(0);
            const color = colorMap[baseNum] || '#000000';
            return `<span style="color: ${color}; text-shadow: 2px 2px #FFFFFF;">${num}</span>`;
        }).join(' ');
    }

    function updateNoteNames() {
        const numbers = parseInput(input.value);
        noteNamesDiv.innerHTML = numbers.map(num => {
            const baseNum = num.charAt(0);
            const noteName = noteMap[baseNum] || '';
            return noteName ? `<span style="color: ${colorMap[baseNum]};">${noteName}</span>` : 'Rest';
        }).join(' ');
    }

    input.addEventListener('input', () => {
        updateChalkboard();
        updateNoteNames();
    });

    function getNoteFrequency(note, octave) {
        const baseFreq = {
            'Do': 261.63, 'Re': 293.66, 'Mi': 329.63, 'Fa': 349.23,
            'Sol': 392.00, 'La': 440.00, 'Si': 493.88
        };
        return baseFreq[note] * Math.pow(2, octave - 4);
    }

    function playNote(num) {
        const baseNum = num.charAt(0);
        if (baseNum === 'x' || baseNum === '-') {
            // Rest
            return new Promise(resolve => setTimeout(resolve, Tone.Time('4n').toSeconds() * 1000));
        }

        const note = noteMap[baseNum];
        let octave = 4;
        if (num.includes("''")) octave = 6;
        else if (num.includes("'")) octave = 5;
        else if (num.includes(",")) octave = num.split(',').length === 2 ? 3 : 2;

        let duration = '4n'; // quarter note by default
        if (num.includes('//')) duration = '16n';
        else if (num.includes('/')) duration = '8n';
        if (num.includes('.')) duration += '.';

        const freq = getNoteFrequency(note, octave);
        synth.triggerAttackRelease(freq, duration);

        return new Promise(resolve => setTimeout(resolve, Tone.Time(duration).toSeconds() * 1000));
    }

    async function playSequence() {
        if (!isPlaying) return;
        if (currentIndex >= sequence.length) {
            if (isLooping) {
                currentIndex = 0;
            } else {
                isPlaying = false;
                return;
            }
        }
        await playNote(sequence[currentIndex]);
        currentIndex++;
        playSequence();
    }

    playBtn.addEventListener('click', () => {
        if (!isPlaying) {
            sequence = parseInput(input.value);
            currentIndex = 0;
            isPlaying = true;
            Tone.start();
            playSequence();
            if (isMidiActive && midiPart) {
                Tone.Transport.start();
            }
        }
    });

    pauseBtn.addEventListener('click', () => {
        isPlaying = false;
        Tone.Transport.pause();
    });

    stopBtn.addEventListener('click', () => {
        isPlaying = false;
        currentIndex = 0;
        Tone.Transport.stop();
    });

    loopBtn.addEventListener('click', () => {
        isLooping = !isLooping;
        loopBtn.textContent = `üîÅ Loop: ${isLooping ? 'On' : 'Off'}`;
        if (midiPart) {
            midiPart.loop = isLooping;
        }
    });

    tempoSlider.addEventListener('input', () => {
        const tempo = tempoSlider.value;
        tempoValue.textContent = tempo;
        Tone.Transport.bpm.value = tempo;
    });

    volumeSlider.addEventListener('input', () => {
        const volume = volumeSlider.value;
        volumeValue.textContent = volume;
        synth.volume.value = Tone.gainToDb(volume / 100);
    });

    fontSizeSlider.addEventListener('input', () => {
        const fontSize = fontSizeSlider.value;
        fontSizeValue.textContent = fontSize;
        chalkboard.style.fontSize = `${fontSize}px`;
    });

    toggleNoteNamesBtn.addEventListener('click', () => {
        noteNamesDiv.style.display = noteNamesDiv.style.display === 'none' ? 'block' : 'none';
    });

    midiFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const midiData = new Uint8Array(e.target.result);
                const midi = new Midi(midiData);
                
                if (midiPart) {
                    midiPart.dispose();
                }

                const synths = [];
                midi.tracks.forEach((track) => {
                    const synth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: {
                            type: 'triangle'
                        },
                        envelope: {
                            attack: 0.02,
                            decay: 0.1,
                            sustain: 0.3,
                            release: 1
                        }
                    }).toDestination();
                    synths.push(synth);
                    
                    const notes = track.notes.map(note => ({
                        time: note.time,
                        note: note.name,
                        duration: note.duration
                    }));
                    
                    const part = new Tone.Part((time, note) => {
                        synth.triggerAttackRelease(note.note, note.duration, time);
                    }, notes);
                    
                    part.start(0);
                });

                midiPart = new Tone.Part(() => {}, []);
                midiPart.loop = isLooping;
                Tone.Transport.bpm.value = midi.header.tempos[0]?.bpm || 120;
                tempoSlider.value = Tone.Transport.bpm.value;
                tempoValue.textContent = Tone.Transport.bpm.value;
            };
            reader.readAsArrayBuffer(file);
        }
    });

    toggleMidiBtn.addEventListener('click', () => {
        isMidiActive = !isMidiActive;
        toggleMidiBtn.textContent = `üéπ MIDI: ${isMidiActive ? 'On' : 'Off'}`;
        if (isMidiActive && isPlaying && midiPart) {
            Tone.Transport.start();
        } else if (!isMidiActive) {
            Tone.Transport.stop();
        }
    });

    playMidiBtn.addEventListener('click', () => {
        if (midiPart) {
            if (Tone.Transport.state === 'started') {
                Tone.Transport.pause();
                playMidiBtn.textContent = '‚ñ∂Ô∏è Play MIDI';
            } else {
                Tone.start();
                Tone.Transport.start();
                playMidiBtn.textContent = '‚è∏Ô∏è Pause MIDI';
            }
        }
    });

    midiVolumeSlider.addEventListener('input', () => {
        const volume = midiVolumeSlider.value;
        midiVolumeValue.textContent = volume;
        Tone.Destination.volume.value = Tone.gainToDb(volume / 100);
    });

    updateChalkboard();
    updateNoteNames();
</script>
</body>
<h3>Albertino Moura 2024 </h3>
</html>